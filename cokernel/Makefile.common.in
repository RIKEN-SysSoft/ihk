# Makefile.common COPYRIGHT FUJITSU LIMITED 2015-2016
CFLAGS += @CFLAGS@
CFLAGS += -Wall -nostdinc -isystem $(shell $(CC) -print-file-name=include) -O2 -g
CFLAGS += -I$(IHKBASE)/$(TARGETDIR)/include -Wno-unused-function -I$(IHKBASE)/../ikc/include
CFLAGS += -DIHK_OS_MANYCORE

TARGETDIR = $(shell echo $(TARGET) | sed "s/-/\//")

ifeq ($(ARCH), arm64)
-include @abs_builddir@/$(TARGETDIR)/Makefile.config
else
-include $(IHKBASE)/$(TARGETDIR)/Makefile.config
endif

CFLAGS += -I$(SRC)/../lib/include -I$(SRC)/../arch/$(IHKARCH)/kernel/include
CFLAGS += -I$(IHKBASE)/$(TARGETDIR)/include
ifeq ($(ARCH), arm64)
CFLAGS += -I@abs_builddir@/../../mckernel/arch/arm64/kernel/include
endif

O ?= .

ifeq ($(V),1)
echo_cmd = 
submake = make
else
echo_cmd = @echo ' ($(TARGET))' $1 $(ECHO_SUFFIX) $2; 
submake = make --no-print-directory
endif

cc_cmd = $(call echo_cmd,CC,$<)$(CC) $(CFLAGS) -c -o $@ $<
ld_cmd = $(call echo_cmd,LD,$@)$(LD) $(LDFLAGS) -r -o $@ $^
dep_cmd = $(call echo_cmd,DEPEND,)$(CC) $(CFLAGS) -MM $1 > $@
rm_cmd = $(call echo_cmd,CLEAN,)$(RM)

define make_implicit_src
$$(O)/%.o: $1/%.c
	$$(cc_cmd)
# POSTK_DEBUG_ARCH_DEP_2, build *.S add __ASSEMBLY__ define
ifeq ($(ARCH), arm64)
$$(O)/%.o: $1/%.S
	$$(cc_cmd) -D__ASSEMBLY__
else
$$(O)/%.o: $1/%.S
	$$(cc_cmd)
endif
endef
