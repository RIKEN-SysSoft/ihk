# Makefile.predefines.in COPYRIGHT FUJITSU LIMITED 2016-2018

#  ARM64_MEMORY_LAYOUT
#  ----+-----------+-----------------------
#    # | page size | virtual memory space
#  ----+-----------+-----------------------
#    1 |       4KB |  39bit [linux-linaro-tracking, upstream kernel]
#    2 |       4KB |  48bit
#    3 |      64KB |  42bit [CentOS]
#    4 |      64KB |  48bit
#  ----+-----------+-----------------------
HOST_DIR=@KDIR@
HOST_CONFIG=$(HOST_DIR)/.config
HOST_KERNEL_CONFIG_ARM64_64K_PAGES=$(shell grep -E "^CONFIG_ARM64_64K_PAGES=y" $(HOST_CONFIG) | sed 's|CONFIG_ARM64_64K_PAGES=||g')
HOST_KERNEL_CONFIG_ARM64_VA_BITS=$(shell grep -E "^CONFIG_ARM64_VA_BITS=" $(HOST_CONFIG) | sed 's|CONFIG_ARM64_VA_BITS=||g')
HOST_KERNEL_CONFIG_NR_CPUS=$(shell grep -E "^CONFIG_NR_CPUS=" $(HOST_CONFIG) | sed 's|CONFIG_NR_CPUS=||g')
HOST_KERNEL_CONFIG_HZ=$(shell grep -E "^CONFIG_HZ=" $(HOST_CONFIG) | sed 's|CONFIG_HZ=||g')
HOST_KERNEL_CONFIG_ARM_GIC_V3=$(shell grep -E "^CONFIG_ARM_GIC_V3=" $(HOST_CONFIG) | sed 's|CONFIG_ARM_GIC_V3=||g')
HOST_KERNEL_CONFIG_ARM64_VHE=$(shell grep -E "^CONFIG_ARM64_VHE=" $(HOST_CONFIG) | sed 's|CONFIG_ARM64_VHE=||g')
HOST_KERNEL_CONFIG_ARM_ARCH_TIMER_EVTSTREAM=$(shell grep -E "^CONFIG_ARM_ARCH_TIMER_EVTSTREAM=" $(HOST_CONFIG) | sed 's|CONFIG_ARM_ARCH_TIMER_EVTSTREAM=||g')

ifeq ($(HOST_KERNEL_CONFIG_ARM64_64K_PAGES), y)
 ifeq ($(HOST_KERNEL_CONFIG_ARM64_VA_BITS), 42)
  ARM64_MEMORY_LAYOUT=3
 else
  ARM64_MEMORY_LAYOUT=4
 endif
else
 ifeq ($(HOST_KERNEL_CONFIG_ARM64_VA_BITS), 39)
  ARM64_MEMORY_LAYOUT=1
 else
  ARM64_MEMORY_LAYOUT=2
 endif
endif

ifeq ($(ARM64_MEMORY_LAYOUT), 1)
 $(info PAGE_SIZE:4KB, VA_BITS:39, PGTABLE_LEVELS:3)
 CFLAGS += -UCONFIG_ARM64_64K_PAGES
 CFLAGS += -DCONFIG_ARM64_VA_BITS=39
 CFLAGS += -DCONFIG_ARM64_PGTABLE_LEVELS=3
endif
ifeq ($(ARM64_MEMORY_LAYOUT), 2)
 $(info PAGE_SIZE:4KB, VA_BITS:48, PGTABLE_LEVELS:4)
 CFLAGS += -UCONFIG_ARM64_64K_PAGES
 CFLAGS += -DCONFIG_ARM64_VA_BITS=48
 CFLAGS += -DCONFIG_ARM64_PGTABLE_LEVELS=4
endif
ifeq ($(ARM64_MEMORY_LAYOUT), 3)
 $(info PAGE_SIZE:64KB, VA_BITS:42, PGTABLE_LEVELS:2)
 CFLAGS += -DCONFIG_ARM64_64K_PAGES
 CFLAGS += -DCONFIG_ARM64_VA_BITS=42
 CFLAGS += -DCONFIG_ARM64_PGTABLE_LEVELS=2
endif
ifeq ($(ARM64_MEMORY_LAYOUT), 4)
 $(info PAGE_SIZE:64KB, VA_BITS:48, PGTABLE_LEVELS:3)
 CFLAGS += -DCONFIG_ARM64_64K_PAGES
 CFLAGS += -DCONFIG_ARM64_VA_BITS=48
 CFLAGS += -DCONFIG_ARM64_PGTABLE_LEVELS=3
endif

$(info NR_CPUS:$(HOST_KERNEL_CONFIG_NR_CPUS))
CFLAGS += -DCONFIG_NR_CPUS=$(HOST_KERNEL_CONFIG_NR_CPUS)
CFLAGS += -DNR_CPUS=CONFIG_NR_CPUS
CFLAGS += -DCONFIG_SMP_MAX_CORES=512
$(info HZ:$(HOST_KERNEL_CONFIG_HZ))
CFLAGS += -DCONFIG_HZ=$(HOST_KERNEL_CONFIG_HZ)

ifeq ($(HOST_KERNEL_CONFIG_ARM_GIC_V3), y)
  CFLAGS += -DCONFIG_ARM_GIC_V3=$(HOST_KERNEL_CONFIG_ARM_GIC_V3)
endif

CONFIG_HAS_NMI=n
ifeq ($(HOST_KERNEL_CONFIG_ARM_GIC_V3), y)
 CONFIG_HAS_NMI=y
 CFLAGS += -DCONFIG_HAS_NMI=y
endif
$(info GICv3:$(HOST_KERNEL_CONFIG_ARM_GIC_V3) NMI:$(CONFIG_HAS_NMI))

ifeq ($(HOST_KERNEL_CONFIG_ARM64_VHE), y)
CFLAGS += -DCONFIG_ARM64_VHE
endif

ifeq ($(HOST_KERNEL_CONFIG_ARM_ARCH_TIMER_EVTSTREAM), y)
CFLAGS += -DCONFIG_ARM_ARCH_TIMER_EVTSTREAM
endif

CFLAGS += -DCONFIG_ARM64_SVE
