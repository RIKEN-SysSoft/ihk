# Makefile.in COPYRIGHT FUJITSU LIMITED 2015-2016
KDIR ?= @KDIR@
ARCH ?= @ARCH@
src := @abs_srcdir@
KMODDIR := @KMODDIR@

ifeq ($(ARCH), x86_64)
	arch := x86
	arch_dir := arch/$(arch)
	arch_objs := $(arch_dir)/smp-x86-startup.o \
                     $(arch_dir)/smp-x86-trampoline_64.o
endif
ifeq ($(ARCH), arm64)
	arch := arm64
	arch_dir := arch/$(arch)
	arch_objs := $(arch_dir)/smp-arm64-startup.o \
                     $(arch_dir)/smp-arm64-trampoline_64.o
# POSTK_DEBUG_ARCH_DEP_84 power management support [BEGIN]
	hpcpwr_dir := @HPCPWR_DIR@
ifneq ($(strip $(hpcpwr_dir)),)
	arch_ccflags-y := -I$(hpcpwr_dir) -DENABLE_HPCPWR
	arch_kbuild_extra_symbols := @HPCPWR_DIR@/Module.symvers
endif
# POSTK_DEBUG_ARCH_DEP_84 power management support [END]
endif

obj-m += ihk-smp-$(arch).o

# POSTK_DEBUG_ARCH_DEP_84 power management support [BEGIN]
#ccflags-y := -I$(src)/../../../cokernel/smp/$(arch) -I$(src)/../../include -I$(src)/../../include/ihk/arch/$(ARCH) -I$(src)/../../../ikc/include \
#             -I@abs_builddir@ -I@abs_builddir@/$(arch_dir)
ccflags-y := -I$(src)/../../../cokernel/smp/$(arch) -I$(src)/../../include -I$(src)/../../include/ihk/arch/$(ARCH) -I$(src)/../../../ikc/include \
             -I@abs_builddir@ -I@abs_builddir@/$(arch_dir) $(arch_ccflags-y)
# POSTK_DEBUG_ARCH_DEP_84 power management support [END]

ihk-smp-$(arch)-y += smp-driver.o $(arch_dir)/smp-arch-driver.o $(arch_objs)

# POSTK_DEBUG_ARCH_DEP_84 power management support [BEGIN]
#KBUILD_EXTRA_SYMBOLS=@abs_builddir@/../../core/Module.symvers
KBUILD_EXTRA_SYMBOLS=@abs_builddir@/../../core/Module.symvers $(arch_kbuild_extra_symbols)
# POSTK_DEBUG_ARCH_DEP_84 power management support [END]

EXTRA_CFLAGS += $(foreach i, $(shell seq 1 100), $(addprefix -DPOSTK_DEBUG_ARCH_DEP_, $(i)))
EXTRA_CFLAGS += $(foreach i, $(shell seq 1 100), $(addprefix -DPOSTK_DEBUG_TEMP_FIX_, $(i)))

.PHONY: clean install modules

modules:
	$(MAKE) -C $(KDIR) M=$(PWD) SUBDIRS=$(PWD) ARCH=$(ARCH) modules

clean:
	$(RM) .*.cmd *.mod.c *.o *.ko* Module.symvers modules.order -r .tmp*

install:
	mkdir -p -m 755 $(KMODDIR)
	install -m 644 ihk-smp-$(arch).ko $(KMODDIR)
